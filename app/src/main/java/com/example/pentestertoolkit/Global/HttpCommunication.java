package com.example.pentestertoolkit.Global;

import android.content.Context;
import android.os.AsyncTask;
import android.os.Handler;
import android.util.Log;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;

public class HttpCommunication{
    
    private String request;
    
    private String response;

    private HttpCommunicationCallback hcCallback;
    
    public HttpCommunication(String request, HttpCommunicationCallback hcCallback){
        
        this.request = request;
        
        this.response = "";

        this.hcCallback = hcCallback;

        
    }


    public void sendRequest(){

        new Thread(new Runnable() {
            @Override
            public void run() {

                try{

                    // Creating request
                    URL url = new URL(request.split(" ")[1]);
                    HttpURLConnection httpUrlConnection = (HttpURLConnection) url.openConnection();

                    // Set request method
                    httpUrlConnection.setRequestMethod(request.split(" ")[0]);

                    //Set headers to request
                    String[] requestLines = request.split("\n");

                    for(String header : requestLines) {
                        if (header.split(" ")[0].contains(":")) {
                            String header_name = header.split(" ")[0];
                            header_name = header_name.substring(0, header_name.length()-1);
                            String header_value  = header.split(" ")[1];

                            //Setting header to request
                            httpUrlConnection.setRequestProperty(header_name, header_value);
                        }
                    }

                    //Send Request
                    httpUrlConnection.connect();


                    //Receive Response
                    BufferedReader bufferedReader = new BufferedReader(new InputStreamReader(httpUrlConnection.getInputStream()));
                    String line;
                    while ((line = bufferedReader.readLine()) != null)
                        response += line + "\n";



                    bufferedReader.close();
                    httpUrlConnection.disconnect();

                    Log.i("HC_RESPONSE", response);


                    if (!response.isEmpty()){
                        hcCallback.onResponseReceived(response);
                    }


                }catch (Exception e){
                    e.printStackTrace();
                    response = "Error";
                }

            }
        }).start();

    }

    public interface HttpCommunicationCallback{

        void onResponseReceived(String mResponse);

    }
}
