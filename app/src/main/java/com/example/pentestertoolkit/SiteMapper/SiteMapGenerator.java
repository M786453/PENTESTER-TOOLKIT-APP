package com.example.pentestertoolkit.SiteMapper;

import android.os.AsyncTask;
import android.util.Log;
import android.widget.LinearLayout;

import androidx.annotation.NonNull;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.ArrayList;

public class SiteMapGenerator extends AsyncTask<Void, Void, LinkClassifier> {

    private String site_url;

    private LinkClassifier linkClassifier;

    private SiteMapCallback siteMapCallback;

    public SiteMapGenerator(SiteMapCallback siteMapCallback, LinearLayout linearLayoutSiteMap, String site_url){

        this.site_url = site_url;

        this.linkClassifier = new LinkClassifier(linearLayoutSiteMap);

        this.siteMapCallback = siteMapCallback;

    }


    @Override
    protected LinkClassifier doInBackground(Void... voids) {

        generateSiteMap();

        return linkClassifier;
    }

    @Override
    protected void onPostExecute(LinkClassifier linkClassifier) {
        if (siteMapCallback != null)
            siteMapCallback.OnSiteMapGenerated(linkClassifier);
    }

    private void generateSiteMap(){


        try{

            Document site_doc = Jsoup.connect(site_url).get();

            Elements link_elements = site_doc.select("a[href]");

            for (Element link: link_elements){

                String href = link.attr("href");

                if (!href.startsWith("#") && !href.startsWith("mailto:") && !href.startsWith("tel:") && !href.isEmpty()){

                    if (href.contains("http://") || href.contains("https://"))
                        href = href.split("//")[1];

                    if (href.contains("www"))
                        href = href.split("www.")[1];

                    linkClassifier.addLink(href);

                }

            }

        }catch (Exception e){
            e.printStackTrace();
        }

    }


    public interface SiteMapCallback{

        void OnSiteMapGenerated(LinkClassifier classifier);

    }



}
