package com.example.pentestertoolkit.GoogleDork;

import android.os.AsyncTask;
import android.util.Log;
import android.widget.ArrayAdapter;
import android.widget.ListView;

import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.ArrayList;

public class GoogleDorker extends AsyncTask<Void, Void, Void> {

    private String search_query;

    private ArrayList<String> scraped_links_list;

    private ArrayAdapter<String> dork_listview_adapter;

    private ListView dork_listview;

    public GoogleDorker(ListView dork_listview, ArrayAdapter<String> dork_listview_adapter, ArrayList<String> scraped_links_list, String search_query){
        this.search_query = search_query;
        this.scraped_links_list = scraped_links_list;
        this.dork_listview = dork_listview;
        this.dork_listview_adapter = dork_listview_adapter;
    }


    @Override
    protected Void doInBackground(Void... voids) {

        while (true) {
            if(scrapeGoogleSearchedLinks(search_query))
                break;
        }
        return null;
    }


    private boolean scrapeGoogleSearchedLinks(String query){

        try {

            int search_index = scraped_links_list.size();

            String GOOGLE_SEARCH_URL = "https://www.google.com.pk/search?q=" + query + "&start=" + search_index;

            Document search_document = Jsoup.connect(GOOGLE_SEARCH_URL).get();

            Elements searched_links_divs = search_document.getElementsByClass("yuRUbf");

            if (searched_links_divs.size() == 0)
                return true;

            for (Element link_div : searched_links_divs) {

                String link = link_div.getElementsByTag("a").attr("href");

                if (!scraped_links_list.contains(link)){
                    scraped_links_list.add(link);//avoid duplicates
                    //Update listview
                    dork_listview.post(new Runnable() {
                        @Override
                        public void run() {
                            dork_listview_adapter.notifyDataSetChanged();
                        }
                    });

                }

            }

        }catch (Exception e){
            Log.i("DORK ERROR", e.getMessage());
            return true;
        }

        return false;
    }


}
