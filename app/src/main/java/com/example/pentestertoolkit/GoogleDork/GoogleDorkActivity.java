package com.example.pentestertoolkit.GoogleDork;

import androidx.appcompat.app.AppCompatActivity;

import android.os.Bundle;
import android.util.Log;
import android.view.View;
import android.widget.AdapterView;
import android.widget.ArrayAdapter;
import android.widget.EditText;
import android.widget.ImageView;
import android.widget.ListView;
import android.widget.TextView;
import android.widget.Toast;

import com.example.pentestertoolkit.Global.CopyText;
import com.example.pentestertoolkit.Global.HttpCommunication;
import com.example.pentestertoolkit.Privacy.ProxySection.ProxyClient;
import com.example.pentestertoolkit.R;

import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.nodes.Element;
import org.jsoup.select.Elements;

import java.util.ArrayList;

public class GoogleDorkActivity extends AppCompatActivity {

    private ListView dork_results_listview;

    private ArrayList<String> all_scraped_links;

    private ArrayAdapter<String> scraped_links_adapter;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_google_dork);

        getSupportActionBar().hide();

        all_scraped_links = new ArrayList<>();

        scraped_links_adapter = new ArrayAdapter<>(GoogleDorkActivity.this, R.layout.listview_item_google_dork,R.id.txtGoogleDork, all_scraped_links);


        // Initialize UI Components
        EditText edtSearchQuery = findViewById(R.id.edt_google_dork_query);
        ImageView imgSettings = findViewById(R.id.img_settings_google_dork);
        dork_results_listview = findViewById(R.id.scraped_links_listview);

        //set adapter to listview
        dork_results_listview.setAdapter(scraped_links_adapter);


        imgSettings.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View view) {

                    String query = edtSearchQuery.getText().toString();

                    if (query.isEmpty()){
                        Toast.makeText(GoogleDorkActivity.this, "EMPTY QUERY", Toast.LENGTH_SHORT).show();
                        return;
                    }

                    Toast.makeText(GoogleDorkActivity.this, "Searching...", Toast.LENGTH_LONG).show();
                    new Thread(new Runnable() {
                        @Override
                        public void run() {
                            while (true) {

                                if(performGoogleSearch(query)) {
                                    //stop search
                                    runOnUiThread(new Runnable() {
                                        @Override
                                        public void run() {
                                            Toast.makeText(GoogleDorkActivity.this, "Search done.", Toast.LENGTH_SHORT).show();
                                        }
                                    });
                                    break;
                                }
                            }
                        }
                    }).start();
            }
        });


        dork_results_listview.setOnItemLongClickListener(new AdapterView.OnItemLongClickListener() {
            @Override
            public boolean onItemLongClick(AdapterView<?> adapterView, View view, int i, long l) {
                TextView txtLink = view.findViewById(R.id.txtGoogleDork);
                CopyText.copy(GoogleDorkActivity.this, txtLink.getText().toString());
                Toast.makeText(GoogleDorkActivity.this, "Copied!", Toast.LENGTH_SHORT).show();
                return true;
            }
        });

    }



    private boolean performGoogleSearch(String query){

        try {

            int search_index = all_scraped_links.size();

            String GOOGLE_SEARCH_URL = "https://www.google.com.pk/search?q=" + query + "&start=" + search_index;

            Connection connection = Jsoup.connect(GOOGLE_SEARCH_URL);

            //configure jsoup connection with proxy
            if (ProxyClient.isConnected)
            connection.proxy(ProxyClient.proxy);

            Connection.Response response = connection.execute();

            String html = response.body();

            if (extractLinksFromResponse(html))
                return true;



        }catch (Exception e){
            Log.i("DORK ERROR", e.getMessage());
        }

        return false;
    }


    private boolean extractLinksFromResponse(String html_response){

        try{



            Document search_document = Jsoup.parse(html_response);

            Elements searched_links_divs = search_document.getElementsByClass("yuRUbf");

            if (searched_links_divs.size() == 0)
                return true;

            Log.i("LINKS_FOUND", searched_links_divs.size() + "");
            for (Element link_div : searched_links_divs) {

                String link = link_div.getElementsByTag("a").attr("href");

                if (!all_scraped_links.contains(link)){
                    all_scraped_links.add(link);//avoid duplicates

                    runOnUiThread(new Runnable() {
                        @Override
                        public void run() {
                            scraped_links_adapter.notifyDataSetChanged();
                        }
                    });
                }

            }



        }catch (Exception e){
            e.printStackTrace();
            Log.i("GD_ERROR", e.getMessage());
        }

        return false;
    }
}