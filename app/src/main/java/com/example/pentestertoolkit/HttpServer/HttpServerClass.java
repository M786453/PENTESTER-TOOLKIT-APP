package com.example.pentestertoolkit.HttpServer;

import android.os.Environment;
import android.widget.TextView;

import com.example.pentestertoolkit.Global.FileManagement;

import org.w3c.dom.Text;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.Map;

import fi.iki.elonen.NanoHTTPD;

public class HttpServerClass extends NanoHTTPD {

    private String server_root;
    private String server_address;
    private int port;
    private ServerCallback serverCallback;

    public HttpServerClass(String server_root, int port, ServerCallback serverCallback) {
        super(port);
        this.port = port;
        this.server_root = server_root;
        this.serverCallback = serverCallback;
        new Thread(new Runnable() {
            @Override
            public void run() {
                setServerAddress();
            }
        }).start();
    }

    @Override
    public Response serve(String uri, Method method, Map<String, String> headers, Map<String, String> parms, Map<String, String> files) {

        // Logging Requests
        HttpServerActivity.httpServerLogs += "\nRequest: " + method + " " + uri;

        // Updating Logs textview
        serverCallback.onRequestReceived();

        // Building Response
        String response = "";

        try{

            // Reading index.html file
            String index_file_path = server_root + "/index.html";

            FileReader index = new FileReader(index_file_path);

            BufferedReader reader = new BufferedReader(index);

            String line = "";

            while((line = reader.readLine()) != null){
                response += line;
            }

            reader.close();


        }catch (Exception e){
            e.printStackTrace();
        }


        return newFixedLengthResponse(response);
    }


    private String setServerAddress(){

        String ip_check_command = "/system/bin/ifconfig";

        String command_result = "";

        try {

            Process process = Runtime.getRuntime().exec(ip_check_command);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));

            String line;
            int addr_line_no = 0;
            while ((line = reader.readLine()) != null) {
                if (addr_line_no == 1)
                    command_result += line + "\n";

                if(line.contains("wlan0"))
                    addr_line_no++;

            }

            this.server_address = command_result.split(":")[1].split(" ")[0];

            reader.close();

        } catch (IOException e) {
            e.printStackTrace();
        }

        return server_address;
    }

    public String getServer_address() {
        return server_address;
    }

    public int getPort() {
        return port;
    }

    public interface ServerCallback{

        void onRequestReceived();
    }
}
